# 寄付フローにおけるウォレット連携要件の見直し

Xamanドキュメントに基づく技術的最適化と、メンテナー・寄付者の役割分離による寄付フローの改善

## ステータス

Approved-承認

## コンテキスト

現在の実装では、寄付者とメンテナーの両方にウォレット連携を要求しているが、以下の課題が明らかになった：

### 技術的課題

- Xamanペイロード生成時の`Account`フィールド事前指定は、Xamanドキュメントによると不要
- 事前指定により、ユーザーのウォレット選択の柔軟性が損なわれている
- 実装が複雑化し、保守性が低下している

### UX課題

- ウォレット連携という追加手順により、寄付のハードルが上がっている

### 設計課題

- メンテナー（寄付受け取り）と寄付者（寄付実行）で異なるウォレット連携要件があるにも関わらず、同一の仕組みを適用している

## 決定内容

### 1. メンテナー向けウォレット連携の強化

- **必須要件**: OSSメンテナーは寄付受け取りアドレス設定のためウォレット連携必須
- **アクセス制御**: ウォレット連携済みユーザーのみメンテナー管理画面へのアクセス可能
- **理由**: 寄付受け取り用のウォレットアドレスを確実に設定・管理する必要があるため

### 2. 寄付者向けウォレット連携の撤廃

- **要件変更**: 寄付者はウォレット連携不要
- **寄付方法**: 任意のウォレットアドレスで寄付実行可能
- **GitHubログイン**: 将来のライセンス管理機能のため維持（ウォレット連携とは独立）
- **理由**: 寄付の敷居を下げ、より多くのユーザーが気軽に寄付できるようにするため

### 3. UI/UX改善

- **寄付ボタン**: 常時有効化（ウォレット連携状態に依存しない）
- **ボタン配置**: 寄付ボタンのみを配置
- **状態表示**: 特になし
- **理由**: ユーザーが直感的に操作でき、必要な手順を理解しやすくするため

### 4. 技術的実装の最適化

- **ペイロード生成**: `Account`フィールドを削除してXamanの自動設定に委ねる
- **寄付履歴**: 署名後に実際の署名者アドレスを取得し、`donationRecords`に記録
- **トラストライン確認**: トラストラインの確認が不要なように、トークンを発行して送付する際には`CreateCheck`トランザクションを利用する
- **理由**: Xamanの推奨実装に準拠し、より堅牢で保守しやすいコードにするため

`CreateCheck`トランザクションを利用することで、寄付者が任意のウォレットで寄付できるようになり、\
寄付者はトラスとラインが無くても、`CheckCash`トランザクションを自身で実行した際にトークンを受け取ることができる

## 影響

### 良い影響

- **UX向上**: 寄付者の手続きが簡素化され、寄付のハードルが下がる
- **技術的最適化**: Xamanの推奨実装に準拠し、実装が簡素化される
- **役割明確化**: メンテナーと寄付者の要件が適切に分離される
- **柔軟性向上**: ユーザーが任意のウォレットで寄付可能になる
- **保守性向上**: 不要なコードが削除され、実装が簡潔になる

### 悪い影響・リスク

- **既存ユーザーへの影響**: 現在ウォレット連携済みの寄付者への説明が必要
- **履歴の一貫性**: 過去の寄付履歴との整合性確保が必要
- **テスト工数**: 新しいフローの十分なテスト実施が必要
- **学習コスト**: 開発チームが新しいフローを理解する必要がある

### 実装影響範囲

- **フロントエンド**: 寄付者向けページのウォレット連携要求削除、UI改善
- **バックエンド**: ペイロード生成API修正、署名後処理ロジック追加
- **データベース**: 既存スキーマは維持、動的アドレス記録ロジック追加

## 参照

- [Xaman Payload Lifecycle Documentation](https://docs.xaman.dev/concepts/payloads-sign-requests/lifecycle)
- ADR-20250603-01: 寄付フローとトークン発行システムについて
- ADR-20250604-01: XamanWebSocket待機処理について
- `src/services/DonationService.ts` - 寄付サービス実装
- `src/services/donation/TrustLineManager.ts` - トラストライン管理実装
- `src/services/WalletLinkService.ts` - ウォレット連携サービス実装
- [トラストラインが不要なトークンの発行方法](https://chatgpt.com/share/6842ef03-be54-800f-8b20-fe3a6e80c32e)
